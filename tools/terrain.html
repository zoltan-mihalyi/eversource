<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<canvas id="canvas" width="330" height="330" style="image-rendering: pixelated; zoom: 250%"></canvas>
<script src="terrain.js"></script>
<script>

    const VOID = 0x330033;
    const SAND = 0xf8d6a3;
    const DIRT_WET = 0x723e2a;
    const DIRT_NORMAL = 0x926c42;
    const DIRT_DRY = 0xb88751;
    const LAVA = 0xbb3300;
    const MOUNTAIN = 0x666666;
    const GRASS = 0x2f8136;
    const WATER = 0x156c99;
    const WATER_SHALLOW = 0x497984;
    const WATER_SHALLOW_SAND = 0x598c9c;
    const WATER_DEEP = 0x000055;
    const RADIUS = 52;
    const SNOW = 0xdddddd;

    function centerDistance(x, y) {
        const dist = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
        return dist > RADIUS ? dist - RADIUS : 0;
    }

    const octaves = 10;
    var heightNoises = noises(0.314651964);
    var heightNoises2 = noises(0.2484641);
    var heightNoises3 = noises(0.5718313);

    var temperatureNoise = noises(0.8413645);
    var hardnessNoise = noises(0.2947664);
    var moistureNoise = noises(0.38471595);

    // noise.seed(0.914651964);
    // noise.seed(Math.random());

    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');

    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var data = imageData.data;

    let zoom = 3;
    // let zoom = 1;

    // const cx = -30;
    // const cy = 10;
    const cx=0;
    const cy=0;

    const width2 = canvas.width / 2;
    const height2 = canvas.height / 2;

    function draw() {
        // zoom *= 1.1;

        for (var x = 0; x < canvas.width; x++) {
            for (var y = 0; y < canvas.height; y++) {
                var worldX = (x - width2) / zoom + cx;
                var worldY = (y - height2) / zoom + cy;

                const ind = (x + y * canvas.width) * 4;

                const moisture = (octaved(moistureNoise, 31, worldX, worldY) + 2) * 60;
                const hardness = (octaved(hardnessNoise, 37, worldX, worldY) + 2) * 60;
                const temperature = (octaved(temperatureNoise, 53, worldX, worldY) + 2) * 60;

                const h1 = (octaved(heightNoises, 49, worldX, worldY) + 2) * 60;
                const h2 = (octaved(heightNoises2, 75, worldX, worldY) + 2) * 60;
                const h3 = (octaved(heightNoises3, 176, worldX, worldY) + 2) * 60;

                let a1 = (h1 - 150) / 4;
                let a2 = (h2 - 130) / 2;
                let a3 = (h3 - 90);

                let color = 0;
                const dist = centerDistance(worldX, worldY);
                const water = a1 + a2 + a3;

                if (dist > 0) {
                    color = VOID;
                } else if (water > 5) {
                    color = WATER_DEEP;
                } else if (water > 0) {
                    color = WATER;
                } else if (water > -5 && hardness < 110) {

                    color = temperature > 110 ? WATER_SHALLOW_SAND : WATER_SHALLOW;
                } else if (hardness < 110) {
                    if (moisture < 80 && temperature > 110) {
                        color = SAND;
                    } else if (moisture < 110) {
                        color = DIRT_DRY;
                    } else if (moisture < 140) {
                        color = DIRT_NORMAL;
                    } else {
                        color = DIRT_WET;
                    }
                } else if (water < -55) {
                    color = SNOW;
                } else if (water < -25) {
                    color = MOUNTAIN;
                } else {
                    color = GRASS;
                }

                data[ind] = color >> 16;
                data[ind + 1] = (color >> 8) & 255;
                data[ind + 2] = color & 255;
                data[ind + 3] = 255;
            }
        }

        ctx.putImageData(imageData, 0, 0);

        // setTimeout(function () {
        //
        //     requestAnimationFrame(draw);
        // }, 500);
    }

    function noises(r) {
        var result = [];
        for (var i = 0; i < octaves; i++) {
            result.push(new Noise(r));
            r /= 2;
        }
        return result;
    }

    function octaved(noises, scale, x, y) {
        var value = 0;
        for (var i = 0; i < octaves; i++) {

            const ratio = Math.pow(2, i);
            value += noises[i].simplex2(x / scale * ratio, y / scale * ratio) / ratio;
        }
        return value / 1;
    }


    requestAnimationFrame(draw);
</script>
</body>
</html>